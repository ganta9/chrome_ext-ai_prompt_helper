# 改行機能実装のための段階的アプローチ

## 前提

Ver3.0.0は安定動作する基準版として維持する。改行機能の実装はVer4.0.0で行うが、**必ず段階的かつテスト駆動で進める**。

## 失敗した教訓（必読）

`docs/fails.md`の「Ver4.0.0 改行機能実装失敗」を必ず参照すること。以下の行為は厳禁：
- 複雑なイベントシミュレーション
- 一度に複数の変更
- テスト不足での実装進行
- 動作する状態からの大幅な離脱

## 段階的実装プラン

### Phase 1: 現状分析と理解（必須）

#### 1.1 根本原因の調査
```javascript
// 現在の状態（Ver3.0.0）
textarea.textContent = text; // 改行文字は挿入されるが視覚的に表示されない
```

**調査項目：**
- なぜ`textContent`では改行が表示されないのか
- `innerHTML`、`innerText`、`textContent`の違い
- 各AIサイトのDOM構造とCSS設定
- contenteditable要素の仕様

#### 1.2 各サイトの詳細分析
- ChatGPT: どのような入力要素を使用しているか
- Claude.ai: contenteditable要素の特殊な実装
- Gemini: 入力フィールドの構造

### Phase 2: 最小限の実験（1つのサイトのみ）

#### 2.1 単一サイト・単一変更テスト
```javascript
// Ver4.0.0での最初の実験（ChatGPTのみ）
if (textarea.tagName === 'TEXTAREA') {
  textarea.value = text; // 変更なし
} else {
  // 最小限の変更のみ
  textarea.innerText = text; // textContent → innerText
}
```

**テスト項目：**
- プロンプト挿入は動作するか
- 改行は表示されるか
- 送信ボタンは有効か
- 他の機能に影響はないか

#### 2.2 一つずつのアプローチ検証

**アプローチ1**: `innerText`使用
- 利点: 改行を保持しHTMLエスケープ
- 実装: `textarea.innerText = text;`
- テスト: ChatGPTでのみテスト

**アプローチ2**: `innerHTML`使用（アプローチ1が失敗の場合のみ）
```javascript
// 改行文字を<br>に変換（最小限の処理）
const htmlText = text.replace(/\n/g, '<br>');
textarea.innerHTML = htmlText;
```

### Phase 3: 段階的拡張

#### 3.1 成功したアプローチを他サイトに適用
- Claude.aiで同じアプローチをテスト
- Geminiで同じアプローチをテスト
- 各サイトで問題が発生した場合は即座に停止

#### 3.2 サイト別の調整（最小限のみ）
```javascript
// サイト別の処理は最小限に留める
const site = detectAISite();
if (site === 'claude' && 特定の問題が確認された場合のみ) {
  // Claude専用の最小限の修正
}
```

### Phase 4: 完全テスト

#### 4.1 全サイトでのテスト
- 各サイトでプロンプト挿入テスト
- 改行表示テスト
- 送信機能テスト
- 長文プロンプトテスト

#### 4.2 問題発生時の対応
- 問題が発生したサイトは除外して他サイトで進行
- 全サイトで問題が発生した場合は即座にVer3.0.0状態にロールバック

## 禁止事項（厳守）

### ❌ 絶対に行わないこと
1. **複雑なイベント処理**：ClipboardEvent、KeyboardEvent等
2. **DOM操作の複雑化**：appendChild、createElement等の複雑な処理
3. **非同期処理**：setTimeout、Promise等による複雑なタイミング制御
4. **一度に複数変更**：複数行の変更は絶対に避ける
5. **テスト不足**：各段階で必ずテストを実行

### ❌ 避けるべきパターン
```javascript
// このような複雑な処理は禁止
const lines = text.split('\n');
textarea.innerHTML = '';
lines.forEach((line, index) => {
  // 複雑なDOM操作...
});
```

## 成功の基準

### ✅ Phase完了の条件
- 各Phaseで全テスト項目が成功
- Ver3.0.0と同等の安定性を維持
- 改行が視覚的に表示される
- すべての対応サイトで動作

### ✅ 最終目標
- Ver3.0.0の安定性 + 改行表示機能
- コードの複雑性は最小限
- メンテナンス性を維持

## 実装時のチェックリスト

### 開始前
- [ ] `docs/fails.md`を確認済み
- [ ] Ver3.0.0が正常動作することを確認済み
- [ ] 一つのPhaseのみに集中することを確認

### 実装中
- [ ] 一度に変更する行数は最小限（1-3行程度）
- [ ] 各変更後に動作テストを実施
- [ ] 問題発生時は即座に前の状態に戻す

### 完了後
- [ ] 全対応サイトでテスト実施
- [ ] Ver3.0.0と同等の安定性を確認
- [ ] 改行機能が正常に動作することを確認

## 緊急時の対応

### 問題発生時
1. 即座に変更を元に戻す
2. 何が問題だったかを`docs/fails.md`に記録
3. より小さな変更でのアプローチを検討

### ロールバック手順
```bash
# Ver3.0.0の該当ファイルをVer4.0.0にコピー
cp /path/to/v3.0.0/src/content.js /path/to/v4.0.0/src/content.js
```

## 重要な注意事項

この文書は、Ver4.0.0での改行機能実装失敗を教訓として作成されました。**必ず段階的に進め、テストを怠らず、複雑化を避けることが成功の鍵です。**