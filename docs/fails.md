# AI Prompt Helper v8.0.0 失敗事例・バグ記録 - 統合版

**最終更新**: 2025-09-21
**バージョン**: v8.0.0
**目的**: 全バージョンの失敗事例を統合し、開発効率向上と問題予防に活用

## 🔍 記録フォーマット

```
### [日付] [バージョン] 失敗事例タイトル

**何をした（アプローチ）:**
- 実施した作業・変更内容

**どんなバグになった（結果）:**
- 発生した問題・エラー内容

**なぜ失敗したか（原因分析）:**
- 失敗の原因・理由

**対策・解決方法:**
- 実際に取った対策・今後の予防策

**教訓:**
- 今後に活かすべき学び
```

---

# 🚨 最重要失敗事例（v8.0.0）

## Claude.aiプロンプト挿入問題 - 変数システム実装時の複合的失敗

### [2025-09-21] v8.0.0 プロンプトテンプレート変数システム実装中の Claude.ai 挿入失敗

**何をした（アプローチ）:**
- プロンプトテンプレート変数システム `[変数名]` 形式の実装
- カスタマイズモーダルのダークテーマ対応
- CSP (Content Security Policy) 準拠の安全なDOM操作
- Claude.ai専用の挿入ロジック改善

**どんなバグになった（結果）:**
1. **CSPViolation**: インラインイベントハンドラー（`onmouseover`, `onmouseout`）使用でエラー
2. **構文エラー**: 改行文字エスケープ処理の破損で `Uncaught SyntaxError`
3. **Claude.ai挿入失敗**: ChatGPTでは動作するがClaude.aiでプロンプト挿入されない
4. **異常現象**: 手動テストで大量の「2」が自動入力される現象

**なぜ失敗したか（原因分析）:**

#### 1. CSP違反問題
- Claude.aiの厳格なContent Security Policyを理解せずHTML injection実装
- `innerHTML` + インラインイベントハンドラーの組み合わせが危険

#### 2. 構文エラー問題
- ファイル全体の置換処理で改行文字が破損（`'\n\n'` → 実際の改行文字）
- エスケープ処理への理解不足

#### 3. Claude.ai特有問題
- Claude.aiのReact制御システムが他サイトより厳格
- v5.0.0で動作していたClipboard API方式が機能しなくなった
- 「2」自動入力は推測: inputイベント再帰発火またはキーイベント混入

**対策・解決方法:**

#### CSP準拠対応
```javascript
// 危険な実装
button.onmouseover = () => this.style.background = '#3d3d3d';
button.innerHTML = `<span onclick="action()">${text}</span>`;

// 安全な実装
button.addEventListener('mouseenter', () => {
  button.style.background = '#3d3d3d';
});
const span = document.createElement('span');
span.textContent = text;
span.addEventListener('click', action);
```

#### Claude.ai専用挿入
```javascript
// v5.0.0で成功した方式から、さらにシンプルに
if (site === 'claude') {
  const success = document.execCommand('insertText', false, newText);
  if (success) {
    textarea.dispatchEvent(new Event('input', { bubbles: true }));
  }
}
```

#### 段階的デバッグの重要性
- 一度に複数の修正を行わず、一つずつ動作確認
- ChatGPTで動作 → Claude.aiで失敗の比較分析が解決の鍵

**教訓:**
- **CSP制約の事前調査**: 各サイトのセキュリティポリシーを理解してから実装
- **サイト別特化アプローチ**: 全サイト共通実装ではなく、サイト固有の対応が必要
- **デバッグの基本**: 「動作するサイト vs 動作しないサイト」の比較分析
- **段階的実装**: 大きな機能追加時は小さく分けて検証

---

# 🚨 Git管理の最重要失敗事例

### [2025-09-13] v6.0.0 Git Push忘れによる開発混乱

**何をした（アプローチ）:**
- ローカルでscript.jsを修正（selectPrompt関数定義済み）
- **git add、git commit、git pushを実行せず**
- GitHub Pagesには古いバージョンが残存
- ユーザーはGitHub Pagesでテストするため古いバージョンを実行

**どんなバグになった（結果）:**
- 「修正したのに動作しない」状況が継続
- 8つの無意味な修正を連続実施
- 数時間の無駄な作業と複雑化したコード

**なぜ失敗したか（原因分析）:**
1. **基本的なGitワークフローの軽視**
2. **ローカル修正 = デプロイ完了の錯覚**
3. **環境の違いへの意識不足**（ローカル vs GitHub Pages）

**対策・解決方法:**
```bash
# 修正作業の必須フロー
1. ローカル修正
2. git add [ファイル名]      # 必須
3. git commit -m "説明"      # 必須
4. git push origin main      # 必須
5. GitHub Pages反映待機（2-3分）
6. 本番環境での動作確認     # 必須
```

**教訓:**
- **🔥 修正 = デプロイまで**: ローカル修正だけでは未完了
- **git pushは修正作業の一部**: オプションではなく必須手順
- **本番環境での確認が最終ステップ**: GitHub PagesのURLで動作確認必須

---

# 🚨 デバッグ手順の失敗事例

### [2025-09-14] v8.0.0 React Hydration Error #418 - 原因調査を怠った失敗

**何をした（アプローチ）:**
- React Hydration Error #418を自分の拡張機能の問題と決めつけ
- 時間依存処理の修正、決定的ID生成関数の実装
- サードパーティReact競合回避システムの実装
- **他の拡張機能の影響を調査せず技術的修正を優先**

**どんなバグになった（結果）:**
- **実際は他の拡張機能が原因**だったため、全修正が不要
- 不要なコードが大量追加され、複雑化
- 「拡張機能を削除したらでなくなりました。この拡張機能以外が問題」とユーザーに指摘

**なぜ失敗したか（原因分析）:**
1. **デバッグ手順の完全無視**
   - ユーザーの「真剣にデバッグして」= 調査徹底指示を修正指示と誤解
2. **エラー発生源の未確認**
   - `87c73c54-4afa88b4a680a7b3.js` ← 明らかに外部ファイルを確認しなかった
3. **環境切り分けの怠慢**
   - 他の拡張機能を無効化する基本的手順をスキップ

**対策・解決方法:**
- **🔍 基本調査手順の確立**
1. **エラーファイル名の確認**: 自分のプロジェクトのファイルか判定
2. **環境の単純化**: 他の拡張機能を無効化して再現テスト
3. **段階的切り分け**: 一つずつ要因を特定
4. **原因確定後に修正検討**: 修正が必要か判断

**教訓:**
- **❌ エラーが出たら即修正**: 原因特定前の修正作業は危険
- **✅ 調査 → 原因特定 → 修正検討**: この順序を厳守
- **✅ 環境切り分け最優先**: 他の要因排除が基本

---

# 💡 成功事例とその要因

## [2025年1月] v4.0.0 Clipboard API アプローチ成功

**何をした（アプローチ）:**
- ユーザーの「コピー&ペーストはできるのに」という観察を活用
- 5回の失敗を経て`navigator.clipboard.writeText` + `ClipboardEvent`でペースト操作を再現

**結果:**
- ✅ Claude.aiで改行が正しく表示
- プロンプト挿入機能も正常動作

**なぜ成功したか:**
1. **ユーザー観察の活用**: 「コピー&ペーストができる」が解決の鍵
2. **段階的アプローチ**: 失敗を恐れず段階的に検証
3. **実際のユーザー操作の再現**: DOM操作ではなくイベントシミュレーション

**成功パターン:**
```javascript
navigator.clipboard.writeText(text).then(() => {
  const pasteEvent = new ClipboardEvent('paste', {
    bubbles: true,
    cancelable: true,
    clipboardData: new DataTransfer()
  });
  pasteEvent.clipboardData.setData('text/plain', text);
  textarea.dispatchEvent(pasteEvent);
});
```

---

# 📊 頻出問題パターンと予防策

## 🔴 Critical: 必ず避けるべき失敗パターン

### 1. Git管理問題（最重要）
- **パターン**: ローカル修正後のgit push忘れ
- **被害**: 開発時間の浪費、無意味な修正の積み重ね
- **予防策**: 修正 → git add → git commit → git push → 本番確認の必須化

### 2. 原因調査の怠慢
- **パターン**: エラー発生 → 即座に修正作業開始
- **被害**: 根本原因を見落とし、不要な修正で複雑化
- **予防策**: 環境切り分け → エラー発生源特定 → 原因確定 → 修正検討

### 3. CSP・セキュリティ制約の無視
- **パターン**: innerHTML + インラインイベントハンドラー使用
- **被害**: セキュリティ違反でコード実行停止
- **予防策**: 各サイトのCSP制約を事前調査、安全なDOM操作のみ使用

## 🟡 Important: 開発効率に影響する問題

### 4. 段階的検証の欠如
- **パターン**: 複数修正の同時実施
- **被害**: 問題箇所の特定困難、デバッグ時間増加
- **予防策**: 一度に一つの修正、各段階での動作確認

### 5. サイト間差異の軽視
- **パターン**: 全サイト共通実装の強行
- **被害**: 特定サイトでの動作不良
- **予防策**: サイト別特化アプローチ、サイト固有制約の調査

### 6. 権限・スコープ逸脱
- **パターン**: 指示されていない修正の実施
- **被害**: 意図しない副作用、ユーザー信頼失墜
- **予防策**: 明示的指示の修正のみ、承認なし修正の禁止

## 🟢 Recommended: 品質向上のベストプラクティス

### 7. ユーザー観察の活用
- **成功例**: 「コピー&ペーストはできる」→ Clipboard API成功
- **重要性**: 技術的推測より実際の動作観察が有効
- **実践**: ユーザーフィードバックを技術選択の重要な判断材料とする

### 8. エラーハンドリングの強化
- **実装**: 詳細なログ出力、フォールバック処理
- **効果**: 問題の早期発見と対処
- **実践**: try-catch、複数の挿入手法による確実性向上

---

# 📈 統計情報と改善履歴

## バージョン別失敗・解決状況

### v8.0.0（2025-09-21）
- **新機能**: プロンプトテンプレート変数システム実装
- **重要失敗**: 3件（CSP違反、構文エラー、Claude.ai挿入問題）
- **解決状況**: 全て解決済み
- **新たな成功パターン**: execCommand によるClaude.ai対応

### v7.0.0（2025-09-20）
- **失敗事例**: GitHub API連携で複数の技術問題
- **解決率**: 100%（全て解決済み）

### v6.0.0（2025-09-13）
- **重要失敗**: Git Push忘れによる開発混乱（最重要教訓）
- **失敗事例**: 5件（GitHub Pages関連）
- **解決率**: 100%

### v4.0.0（2025年1月）
- **重要成功**: Clipboard API方式の確立
- **失敗→成功**: 5回の失敗を経て最終的にClipboard API成功

## 学習効果と改善状況

### 予防できるようになった問題
- ✅ **Git管理問題**: 修正フローの標準化で予防
- ✅ **ファイル構造問題**: manifest.json、ディレクトリ設定の理解
- ✅ **基本的なCSP違反**: 安全なDOM操作の習得

### 継続的な注意が必要な領域
- ⚠️ **サイト固有制約**: 新しいAIサイト対応時の個別調査
- ⚠️ **デバッグ手順**: 複雑な問題での原因分析の徹底
- ⚠️ **段階的実装**: 大きな機能追加時の分割検証

---

# 🎯 今後の開発指針

## 必須開発ルール

### 🔥 Critical Rules
1. **修正 = git push + 本番確認まで**: ローカル修正だけでは未完了
2. **問題発生時はデバッグ優先**: 修正作業前に必ず原因特定
3. **環境切り分けは基本**: 他の拡張機能無効化 → 最小再現環境確認

### 🛡️ Safety Rules
1. **CSP準拠必須**: innerHTML、インラインイベント禁止
2. **段階的検証**: 一度に一つの修正、各段階で動作確認
3. **指示厳守**: 明示的指示の修正のみ、スコープ外修正は事前承認

### 💡 Quality Rules
1. **ユーザー観察重視**: 技術的推測よりユーザーフィードバック優先
2. **サイト別最適化**: 全サイト共通より個別対応を選択
3. **エラーハンドリング強化**: ログ出力、フォールバック処理の充実

## 開発フローテンプレート

```bash
# 問題発生時の対応順序
1. git status                # ローカル状況確認
2. git push origin main      # push忘れ確認
3. 他の拡張機能無効化        # 環境切り分け
4. エラー発生源特定         # どのファイルが原因か
5. 原因確定               # なぜ発生するか
6. 修正検討               # 修正が必要か判断
7. 最小限修正             # 必要最小限の変更
8. 動作確認               # 本番環境での検証
```

---

**記録担当**: Claude (claude.ai/code)
**統合完了**: 2025-09-21 (v8.0.0対応)
**次回更新**: 新機能実装・問題発生時